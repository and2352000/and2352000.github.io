<!doctype html><html lang=en-us><head><title>K8S DIY æ¶è¨­æ‰‹ä½œ | Aaron's Blog</title>
<meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="ç’°å¢ƒæº–å‚™ ğŸ”— Public IP Domain Name ä¸€å°ä¸»æ©Ÿ çŒå¥½ Nginx ä½œç‚ºé€™å°ä¸»æ©Ÿçš„å…¥å£ ç”³è«‹å¥½ TLS æ‰€éœ€çš„æ†‘è­‰ ä¸€å° LoadBalancer å…¼é˜²ç«ç‰† Gitlab å¸³è™Ÿ Bootstrapping clusters with kubeadm ğŸ”—å®˜æ–¹å®‰è£æ•™å­¸ï¼šhttps://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/
A compatible Linux host. The Kubernetes project provides generic instructions for Linux distributions based on Debian and Red Hat, and those distributions without a package manager. 2 GB or more of RAM per machine (any less will leave little room for your apps). 2 CPUs or more. Full network connectivity between all machines in the cluster (public or private network is fine)."><meta name=generator content="Hugo 0.123.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon></head><body><nav class=navigation><a href=/><span class=arrow>â†</span>Home</a>
<a href=/posts>Archive</a>
<a href=/tags>Tags</a>
<a href=/about>About</a></nav><main class=main><section id=single><h1 class=title>K8S DIY æ¶è¨­æ‰‹ä½œ</h1><div class=tip><time datetime="2022-08-23 14:01:30 +0800 +0800">Aug 23, 2022</time>
<span class=split>Â·
</span><span>626 words
</span><span class=split>Â·
</span><span>3 minute read</span></div><div class=content><h2 id=ç’°å¢ƒæº–å‚™>ç’°å¢ƒæº–å‚™ <a href=#%e7%92%b0%e5%a2%83%e6%ba%96%e5%82%99 class=anchor>ğŸ”—</a></h2><ul><li>Public IP</li><li>Domain Name</li><li>ä¸€å°ä¸»æ©Ÿ<ul><li>çŒå¥½ Nginx ä½œç‚ºé€™å°ä¸»æ©Ÿçš„å…¥å£</li><li>ç”³è«‹å¥½ TLS æ‰€éœ€çš„æ†‘è­‰</li></ul></li><li>ä¸€å° LoadBalancer å…¼é˜²ç«ç‰†</li><li>Gitlab å¸³è™Ÿ</li></ul><p><p class=markdown-image><img src=images/my_computer.png alt="My Computer"></p></p><h2 id=bootstrapping-clusters-with-kubeadm>Bootstrapping clusters with kubeadm <a href=#bootstrapping-clusters-with-kubeadm class=anchor>ğŸ”—</a></h2><p>å®˜æ–¹å®‰è£æ•™å­¸ï¼šhttps://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/</p><ul><li>A compatible Linux host. The Kubernetes project provides generic instructions for Linux distributions based on Debian and Red Hat, and those distributions without a package manager.</li><li>2 GB or more of RAM per machine (any less will leave little room for your apps).</li><li>2 CPUs or more.</li><li>Full network connectivity between all machines in the cluster (public or private network is fine).</li><li>Unique hostname, MAC address, and product_uuid for every node. See here for more details.</li><li>Certain ports are open on your machines. See here for more details.</li><li>Swap disabled. You MUST disable swap in order for the kubelet to work properly.</li></ul><h2 id=installing-a-container-runtime>Installing a container runtime <a href=#installing-a-container-runtime class=anchor>ğŸ”—</a></h2><p>é€™è£¡å¯ä»¥é¸ç”¨ä½ å–œæ­¡çš„ï¼Œæˆ‘é¸ç”¨ docker</p><h2 id=installing-kubeadm-kubelet-and-kubectl>Installing kubeadm, kubelet and kubectl <a href=#installing-kubeadm-kubelet-and-kubectl class=anchor>ğŸ”—</a></h2><ul><li>kubeadm: the command to bootstrap the cluster.</li><li>kubelet: the component that runs on all of the machines in your cluster and does things like starting pods and containers.</li><li>kubectl: the command line util to talk to your cluster.</li></ul><p>Update the apt package index and install packages needed to use the Kubernetes apt repository:</p><pre tabindex=0><code>sudo apt-get update
sudo apt-get install -y apt-transport-https ca-certificates curl
</code></pre><p>Download the Google Cloud public signing key:</p><pre tabindex=0><code>sudo curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg
</code></pre><p>Add the Kubernetes apt repository:</p><pre tabindex=0><code>echo &#34;deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main&#34; | sudo tee /etc/apt/sources.list.d/kubernetes.list
</code></pre><p>Update apt package index, install kubelet, kubeadm and kubectl, and
pin their version:</p><pre tabindex=0><code>sudo apt-get update
sudo apt-get install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl
</code></pre><h2 id=kubeadm-init>kubeadm init <a href=#kubeadm-init class=anchor>ğŸ”—</a></h2><pre tabindex=0><code>kubeadm init
</code></pre><p>Get admin kubeconfig
To start using your cluster, you need to run the following as a regular user:</p><pre tabindex=0><code>  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config
</code></pre><p>ç•¶ä½ å»æŸ¥çœ‹æ‰€ä»¥æœ‰çš„æœå‹™æœƒç™¼ç¾ï¼ŒCoreDNS ä¸€ç›´æ˜¯è™•åœ¨ pending
ä»¥ä¸‹æ˜¯å®˜ç¿»çš„ trouble shooting</p><h2 id=coredns-is-stuck-in-the-pending-state>CoreDNS is stuck in the Pending state <a href=#coredns-is-stuck-in-the-pending-state class=anchor>ğŸ”—</a></h2><p>This is expected and part of the design. kubeadm is network provider-agnostic, so the admin should install the pod network add-on of choice. You have to install a Pod Network before CoreDNS may be deployed fully. Hence the Pending state before the network is set up.</p><p>è§£æ±ºè¾¦æ³•ï¼šå®‰è£ç¶²è·¯å¥—ä»¶
CoreDNS</p><ul><li><a href=https://cloud.tencent.com/developer/article/1820462 target=_blank rel=noopener>https://cloud.tencent.com/developer/article/1820462</a></li><li><a href=https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/troubleshooting-kubeadm/ target=_blank rel=noopener>https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/troubleshooting-kubeadm/</a></li><li>æˆ‘é¸ç”¨ Weave</li></ul><pre tabindex=0><code>kubectl apply -f &#34;https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d &#39;\n&#39;)&#34;
</code></pre><p>å¦‚æœä½ åªæœ‰ä¸€å°ä¼ºæœå™¨è¦ä¸‹ä¸‹é¢é€™å€‹æŒ‡ä»¤æ‰å¯ä»¥ï¼Œè®“ pod éƒ¨ç½²åœ¨control-panel åŒä¸€å°</p><pre tabindex=0><code>kubectl taint nodes --all node-role.kubernetes.io/control-plane- node-role.kubernetes.io/master-
</code></pre><h2 id=æ–°å¢-user--role--rolebinding>æ–°å¢ User & Role & RoleBinding <a href=#%e6%96%b0%e5%a2%9e-user--role--rolebinding class=anchor>ğŸ”—</a></h2><ul><li>ç°¡å–®é¸ç”¨ RBAC çš„ç­–ç•¥</li><li>é¸æ“‡User èªè­‰æ–¹å¼ï¼Œé€™é‚Šé¸æ“‡CA</li><li>Create Role</li><li>Create RoleBinding</li></ul><p>èªè­‰çš„ä¸‰ç¨®æ–¹æ³•: <a href=https://kubernetes.io/docs/reference/access-authn-authz/bootstrap-tokens/ target=_blank rel=noopener>https://kubernetes.io/docs/reference/access-authn-authz/bootstrap-tokens/</a><br>CA Ref: <a href=https://www.adaltas.com/en/2019/08/07/users-rbac-kubernetes/ target=_blank rel=noopener>https://www.adaltas.com/en/2019/08/07/users-rbac-kubernetes/</a><br>è‡ªè£½CA ç”¢ç”ŸTool: <a href=https://gitlab.com/k8s71/k8s_config_gen target=_blank rel=noopener>https://gitlab.com/k8s71/k8s_config_gen</a><br>mTLS Ref: <a href=https://www.cloudflare.com/zh-tw/learning/access-management/what-is-mutual-tls/ target=_blank rel=noopener>https://www.cloudflare.com/zh-tw/learning/access-management/what-is-mutual-tls/</a></p><p>æ¥ä¸‹ä¾†å°±æ˜¯éƒ¨ç½²æœå‹™</p><pre tabindex=0><code class="language-=yaml" data-lang="=yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: ee-api
  namespace: ee-dev
spec:
  selector:
    matchLabels:
      app: ee-api
  template:
    metadata:
      labels:
        app: ee-api
    spec:
      containers:
      - name: ee-api
        image: registry.gitlab.com/fcuee/ee-api:v0.0.15-release
        resources:
          limits:
            memory: &#34;300Mi&#34;
            cpu: &#34;500m&#34;   
        ports:
        - containerPort: 4000
        env:
        - name: FIREBASE_CRED
          valueFrom:
            secretKeyRef:
              name: ee-api-secret
              key: FIREBASE_CRED
              optional: false
...............çœç•¥.........
      imagePullSecrets:
      - name: docker-rg-key
</code></pre><p>è¨˜å¾—çµ¦k8s docker registry çš„æ¬Šé™</p><pre tabindex=0><code>kubectl create secret docker-registry regcred -n=ee-dev --docker-server=registry.gitlab.com --docker-username=&lt;username&gt; --docker-password=&lt;token&gt; --docker-email=&lt;email&gt; -n=ee-dev
</code></pre><p>Config: <a href=https://gitlab.com/k8s71/config_env target=_blank rel=noopener>https://gitlab.com/k8s71/config_env</a></p><p>Apply deployment yamlï¼Œ pod å•Ÿå‹•äº†ï¼Œé€éport forword çœ‹åˆ°æœå‹™çš„å…§å®¹
æ¥ä¸‹ä¾†å°±æ˜¯è¦æŠŠæœå‹™é–‹åˆ° public</p><h2 id=ingress>Ingress <a href=#ingress class=anchor>ğŸ”—</a></h2><p>å®˜ç¶²ä»‹ç´¹ Ingress çš„ç”¨é€”ï¼šhttps://kubernetes.io/docs/concepts/services-networking/ingress/</p><p>Ingress æœ‰å¾ˆå¤šç¨®ï¼Œé€™è£¡é¸ç”¨nginx ingress(é­”æ”¹éçš„ngnix)</p><ul><li>Nginx ingress yaml
<a href=https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.3.0/deploy/static/provider/cloud/deploy.yaml target=_blank rel=noopener>https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.3.0/deploy/static/provider/cloud/deploy.yaml</a>
å®˜æ–¹Nginx Ingress Docï¼šhttps://docs.nginx.com/nginx-ingress-controller/</li></ul><p>æ¥ä¸‹ä¾†å»æŸ¥çœ‹Service</p><pre tabindex=0><code>kubectl get service -A
</code></pre><p>ä½ æœƒç™¼ç¾ ngnix controller externel IP æ˜¯ pending
ç„¶å¾Œé–‹å§‹ç­‰å¾…&mldr;ç­‰å¾…&mldr;ç­‰å¾…è‰¯äººå›ä¾†é‚£è£¡å•Šï¼ï¼ï¼ å›æ†¶&mldr;.
ï¼±ï¼± è‡ªå·±æ¶è¨­çš„ k8s ä¸åƒ GKE ä¸€æ¨£æœ‰ LoadBalancer å¹«ä½ åˆ†é… IP</p><p>é‚£æœ‰æ²’æœ‰æ¯”è¼ƒç°¡å–®çš„åšæ³•ï¼Œæœ‰çš„ NodePort ç›´æ¥æŠŠ Port å°å¤–
æ–¼æ˜¯æˆ‘å°±å¯ä»¥åœ¨é€™å°é›»è…¦ä¸Š</p><pre tabindex=0><code>curl localhost:30088
</code></pre><p>ç„¶å¾Œä½ æœƒæ‹¿åˆ° 404 page not found
å°±ç®—æ˜¯æˆåŠŸäº†</p><p>æ¥ä¸‹ä¾†æˆ‘å€‘å°±è¦æŠŠæœå‹™èˆ‡Ingress ä¸²èµ·ä¾†ï¼Œä»¥ä¸‹è¨­å®š</p><ul><li>çµ¦é–‹service ä¸€å€‹ ExternalNameï¼Œä¸¦èˆ‡ nginx-ingress åŒ namespace</li></ul><pre tabindex=0><code class="language-=yaml" data-lang="=yaml">  apiVersion: v1
  kind: Service
  metadata:
    name: ee-api-service
    namespace: ingress-nginx
  spec:
    type: ExternalName
    externalName: ee-api-service.ee-dev.svc.cluster.local
    selector:
      app: ee-api
    ports:
    - port: 4000
      targetPort: 4000
</code></pre><ul><li>è¨­å®š Ingress çš„è·¯ç”±</li></ul><pre tabindex=0><code class="language-=yaml" data-lang="=yaml">  apiVersion: networking.k8s.io/v1
  kind: Ingress
  metadata:
    name: ingress-ee-api
    namespace: ingress-nginx
    annotations:
     kubernetes.io/ingress.class: nginx
  spec:
    rules:
    - host: &#34;domain.example.com&#34;
      http:
        paths:
        - pathType: Prefix
          path: &#34;/&#34;
          backend:
            service:
              name: ee-api-service
              port:
                number: 4000
</code></pre><p>ç„¶å¾Œå°±çµæŸäº†å—ï¼ï¼ï¼</p><pre tabindex=0><code>curl domain.example.com
</code></pre><p>åˆå†åº¦çœ‹åˆ° 404</p><p>ç­‰ç­‰ domain.example.com æ˜¯å“ªè£¡ä¾†çš„ï¼Œæˆ‘å€‘å‰é¢æ‰“çš„ä¸æ˜¯ Domain Name è€Œæ˜¯ localhost å•Š</p><p>æ‰€ä»¥æˆ‘é‹ç”¨æˆ‘åŸä¾†serviceä¸Šå°±æœ‰çš„nginx ä½œç‚º LoadBalancer é€é virtual host reverse proxy è½‰ç™¼åˆ° localhost:30088 ä¸Š</p><p>ç„¶å¾Œçµ‚æ–¼é€šäº†ï¼Œå¯å–œå¯è³€</p></div><div class=tags><a href=https://and2352000.github.io/tags/k8s>k8s</a>
<a href=https://and2352000.github.io/tags/docker>docker</a></div></section></main><footer id=footer><div class=copyright>Â© Copyright
2024
<span class=split><svg fill="#bbb" width="15" height="15" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15"><path d="M13.91 6.75c-1.17 2.25-4.3 5.31-6.07 6.94-.1903.1718-.4797.1718-.67.0C5.39 12.06 2.26 9 1.09 6.75-1.48 1.8 5-1.5 7.5 3.45 10-1.5 16.48 1.8 13.91 6.75z"/></svg></span></div><div class=powerby>Powered by <a href=http://www.gohugo.io/>Hugo</a> Theme By <a href=https://github.com/nodejh/hugo-theme-mini>nodejh</a></div></footer></body></html>