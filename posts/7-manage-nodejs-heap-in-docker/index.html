<!doctype html><html lang=en-us><head><title>Manage Nodejs Heap in Docker | Aaron's Blog</title>
<meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Container è¨˜æ†¶é«”èª¿æ•´ ğŸ”—åœ¨ local èª¿æ•´ container è¨˜æ†¶é«”å¦‚ä¸‹
docker run --memory 1024m --interactive --tty ravali1906/dockermemory bash ä½†æ˜¯é€™æ¨£æœƒæœ‰ä¸€å€‹å•é¡Œï¼Œæœ‰ç”±æ–¼ container default æœ‰ swapï¼Œæ‰€ä»¥å³ä¾¿ç”¨è¶…éä¹Ÿä¸æœƒOut of memory
é€™æ®µç¨‹å¼ç¢¼ç¨‹å¼ç¢¼æœƒ allocate 1024MB
const buf = Buffer.alloc(+process.argv[2] * 1024 * 1024) console.log(Math.round(buf.length / (1024 * 1024))) console.log(Math.round(process.memoryUsage().rss / (1024 * 1024))) åŸ·è¡Œçµæœ
$ node buffer_example 2000 2000 16 ä»¥ä¸Šé€™æ®µç¨‹å¼ç¢¼æ˜¯åƒè€ƒ ref1 å…¶å¯¦æ˜¯æœ‰å•é¡Œçš„ Buffer.alloc ä¸¦ä¸æœƒç”¨ä½¿ç”¨åˆ° heap
æˆ‘æœ‰é‡æ–°å¯¦ä½œä½†æ˜¯é‚„ä¸å®Œæ•´&mldr;..
memoryUsage æœ‰å››å€‹è³‡è¨Š heapTotal and heapUsed refer to V8&rsquo;s memory usage. external refers to the memory usage of C++ objects bound to JavaScript objects managed by V8."><meta name=generator content="Hugo 0.127.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon><script async src="https://www.googletagmanager.com/gtag/js?id=G-0YBZ467R0Y"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-0YBZ467R0Y")}</script></head><body><nav class=navigation><a href=/><span class=arrow>â†</span>Home</a>
<a href=/posts>Archive</a>
<a href=/tags>Tags</a>
<a href=/about>About</a></nav><main class=main><section id=single><h1 class=title>Manage Nodejs Heap in Docker</h1><div class=tip><time datetime="2024-02-26 15:07:57 +0800 +0800">Feb 26, 2024</time>
<span class=split>Â·
</span><span>235 words
</span><span class=split>Â·
</span><span>2 minute read</span></div><div class=content><h2 id=container-è¨˜æ†¶é«”èª¿æ•´>Container è¨˜æ†¶é«”èª¿æ•´ <a href=#container-%e8%a8%98%e6%86%b6%e9%ab%94%e8%aa%bf%e6%95%b4 class=anchor>ğŸ”—</a></h2><p>åœ¨ local èª¿æ•´ container è¨˜æ†¶é«”å¦‚ä¸‹</p><pre tabindex=0><code>docker run --memory 1024m --interactive --tty ravali1906/dockermemory bash
</code></pre><p>ä½†æ˜¯é€™æ¨£æœƒæœ‰ä¸€å€‹å•é¡Œï¼Œæœ‰ç”±æ–¼ container default æœ‰ swapï¼Œæ‰€ä»¥å³ä¾¿ç”¨è¶…éä¹Ÿä¸æœƒOut of memory</p><p>é€™æ®µç¨‹å¼ç¢¼ç¨‹å¼ç¢¼æœƒ allocate 1024MB</p><pre tabindex=0><code>const buf = Buffer.alloc(+process.argv[2] * 1024 * 1024)
console.log(Math.round(buf.length / (1024 * 1024)))
console.log(Math.round(process.memoryUsage().rss / (1024 * 1024)))
</code></pre><p>åŸ·è¡Œçµæœ</p><pre tabindex=0><code>$ node buffer_example 2000
2000
16
</code></pre><p>ä»¥ä¸Šé€™æ®µç¨‹å¼ç¢¼æ˜¯åƒè€ƒ ref1 å…¶å¯¦æ˜¯æœ‰å•é¡Œçš„ Buffer.alloc ä¸¦ä¸æœƒç”¨ä½¿ç”¨åˆ° heap</p><p>æˆ‘æœ‰é‡æ–°å¯¦ä½œä½†æ˜¯é‚„ä¸å®Œæ•´&mldr;..</p><ul><li>memoryUsage æœ‰å››å€‹è³‡è¨Š<ol><li>heapTotal and heapUsed refer to V8&rsquo;s memory usage.</li><li>external refers to the memory usage of C++ objects bound to JavaScript objects managed by V8.</li><li>rss, Resident Set Size, is the amount of space occupied in the main memory device (that is a subset of the total allocated memory) for the process, including all C++ and JavaScript objects and code.</li><li>arrayBuffers refers to memory allocated for ArrayBuffers and SharedArrayBuffers, including all Node.js Buffers. This is also included in the external value. When Node.js is used as an embedded library, this value may be 0 because allocations for ArrayBuffers may not be tracked in that case.</li></ol></li></ul><p>å¦‚æœè¦æª¢æŸ¥ container çš„è¨˜æ†¶é«”å¤§å°å¯ä»¥çœ‹é€™è£¡</p><pre tabindex=0><code>cat /sys/fs/cgroup/memory.max
</code></pre><ul><li>NodeJs Resident Set ç¤ºæ„åœ–<p class=markdown-image><img src=images/nodejs_resident_set.png alt="NodeJs Resident Set"></p>å¦‚æœè¦æŠŠé™åˆ¶æˆ–æ“´å¢ memory çš„ç¸½æ•¸è¦é€é V8 åƒæ•¸è¨­å®šï¼Œæ¯ä¸€å€‹ Nodejs çš„ç‰ˆæœ¬å°æ–¼è¨˜æ†¶é«”çš„æœ€å¤§å€¼æœ‰æ‰€ä¸åŒå°¤å…¶æ˜¯ 32bitçš„ç‰ˆæœ¬</li></ul><h2 id=æŸ¥çœ‹-heap-åƒæ•¸>æŸ¥çœ‹ Heap åƒæ•¸ <a href=#%e6%9f%a5%e7%9c%8b-heap-%e5%8f%83%e6%95%b8 class=anchor>ğŸ”—</a></h2><p>ç”±æ–¼ NodeJs æ˜¯ç”± V8 engine ä¾†ç®¡ç†è¨˜æ†¶é«”ï¼Œæ‰€ä»¥å¦‚æœè¦èª¿æ•´æƒ³é—œåƒæ•¸è¦åƒé–± V8çš„è¨­å®š</p><pre tabindex=0><code>node --v8-options
# å…¶ä¸­ max_old_space_size å¯ä»¥ç”¨ä¾†èª¿æ•´ heap å¤§å°
node --v8-options | grep &#34;max_old_space_size&#34;
</code></pre><h2 id=debug-tool>Debug Tool <a href=#debug-tool class=anchor>ğŸ”—</a></h2><p>Open <a href=chrome://inspect>chrome://inspect</a></p><pre tabindex=0><code>node --inspect index.js
# NOTE: In container
node --inspect-brk=0.0.0.0 --max_old_space_size=2000  index.js 200
</code></pre><h2 id=reference>Reference <a href=#reference class=anchor>ğŸ”—</a></h2><ul><li><a href=https://developer.ibm.com/articles/nodejs-memory-management-in-container-environments/ target=_blank rel=noopener>IBM Node.js memory management in container environments</a></li><li><a href=https://levelup.gitconnected.com/understanding-call-stack-and-heap-memory-in-js-e34bf8d3c3a4 target=_blank rel=noopener>https://levelup.gitconnected.com/understanding-call-stack-and-heap-memory-in-js-e34bf8d3c3a4</a></li><li><a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer target=_blank rel=noopener>Share Buffer In Nodejs</a></li><li><a href=https://nodejs.org/api/process.html#processmemoryusage target=_blank rel=noopener>NodeJs memoryUsage</a></li></ul></div><div class=tags><a href=https://and2352000.github.io/tags/code>code</a>
<a href=https://and2352000.github.io/tags/nodejs>nodejs</a></div></section></main><footer id=footer><div class=copyright>Â© Copyright
2024
<span class=split><svg fill="#bbb" width="15" height="15" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15"><path d="M13.91 6.75c-1.17 2.25-4.3 5.31-6.07 6.94-.1903.1718-.4797.1718-.67.0C5.39 12.06 2.26 9 1.09 6.75-1.48 1.8 5-1.5 7.5 3.45 10-1.5 16.48 1.8 13.91 6.75z"/></svg></span></div><div class=powerby>Powered by <a href=http://www.gohugo.io/>Hugo</a> Theme By <a href=https://github.com/nodejh/hugo-theme-mini>nodejh</a></div></footer></body></html>