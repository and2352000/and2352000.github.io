<!doctype html><html lang=en-us><head><title>Monitor Third Party Source Through JS proxy and Google Cloud Metric | Aaron's Blog</title>
<meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Problem Face üîóThere&rsquo;s too many function or class will build and each client (class of third party library). We need a general solution to help us to monitor different source from multiple vendor also each function of class.
What we want to know? The following data Request Count, Response Count, Response Error Count can be aggregated according to the number of days or counted independently according to different types of functions, blockchains and suppliers, while maintaining flexibility Javascript proxy üîóThe Proxy object enables you to create a proxy for another object, which can intercept and redefine fundamental operations for that object."><meta name=generator content="Hugo 0.127.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon><script async src="https://www.googletagmanager.com/gtag/js?id=G-0YBZ467R0Y"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-0YBZ467R0Y")}</script></head><body><nav class=navigation><a href=/><span class=arrow>‚Üê</span>Home</a>
<a href=/posts>Archive</a>
<a href=/tags>Tags</a>
<a href=/about>About</a></nav><main class=main><section id=single><h1 class=title>Monitor Third Party Source Through JS proxy and Google Cloud Metric</h1><div class=tip><time datetime="2023-07-18 14:01:30 +0800 +0800">Jul 18, 2023</time>
<span class=split>¬∑
</span><span>602 words
</span><span class=split>¬∑
</span><span>3 minute read</span></div><div class=content><h2 id=problem-face>Problem Face <a href=#problem-face class=anchor>üîó</a></h2><p>There&rsquo;s too many function or class will build and each client (class of third party library). We need a general solution to help us to monitor different source from multiple vendor also each function of class.</p><ul><li>What we want to know?
The following data Request Count, Response Count, Response Error Count can be aggregated according to the number of days or counted independently according to different types of functions, blockchains and suppliers, while maintaining flexibility</li></ul><h2 id=javascript-proxy>Javascript proxy <a href=#javascript-proxy class=anchor>üîó</a></h2><p>The Proxy object enables you to create a proxy for another object, which can intercept and redefine fundamental operations for that object. <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy target=_blank rel=noopener>MDN JS Proxy</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Client</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>getDataA</span>()<span style=color:#f92672>:</span> <span style=color:#a6e22e>string</span> { <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;This is A&#39;</span> }
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>getDataB</span>() { <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Something wrong with B&#39;</span>) }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>client</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Client</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>clientProxy</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Proxy(<span style=color:#a6e22e>client</span>, {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>get</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>target</span>, <span style=color:#a6e22e>prop</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;Function &#39;</span>, <span style=color:#a6e22e>prop</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> () =&gt; { <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;hello&#39;</span> }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>clientProxy</span>.<span style=color:#a6e22e>getDataA</span>())
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>clientProxy</span>.<span style=color:#a6e22e>getDataB</span>())
</span></span></code></pre></div><p><a href="https://www.typescriptlang.org/play?ssl=15&amp;ssc=36&amp;pln=1&amp;pc=1#code/MYGwhgzhAEDCIEsCmA7ALtA3gKGtA5kmgCJhpgCCAFAJQBc0EaATgivltM0QK7MrQA5ABUAFghgToFQdAC+uAkVLkAQrU5pRzAPYB3aCiQGAos13MqggMo6AtkXHtoe3c70It0VYJrzsCtjAOihM0KDI6NAAvIbGcIioaLQA3EEhYRFJAAq6AB4AnjFxBrk6hVRZ6AA0WIqEaAxU5MwNtQAOuu1+0QB8dXh4waE6IEgAdCA6+FYAYjwowGgIIUIdXTSKeNxofAIafZw7e0KiSCBTsgp4CnI0aekjY5PTlYnoZYXjDSqUtJvDCCjCZTGZVNCfArfZRkMDqGg0IA" target=_blank rel=noopener>example</a></p><h2 id=metric>Metric <a href=#metric class=anchor>üîó</a></h2><p>What are metrics?
In layperson terms, metrics are numeric measurements. Time series means that changes are recorded over time. What users want to measure differs from application to application. For a web server it might be request times, for a database it might be number of active connections or number of active queries etc.<a href=https://prometheus.io/docs/introduction/overview/ target=_blank rel=noopener>Ref</a></p><ul><li>Logbase Metric
Logs are emitted from almost every program and write every detail down. We can analytic data later. <a href=https://cloud.google.com/logging/docs/logs-based-metrics target=_blank rel=noopener>Google LogBase Metric</a></li><li>Promethus metric
Prometheus scrapes metrics from instrumented jobs, either directly or via an intermediary push gateway for short-lived jobs. <a href=https://prometheus.io/docs/introduction/overview/ target=_blank rel=noopener>Prometheus Metric</a><p class=markdown-image><img src=images/metric_architecture.png alt="Metric Architecture"></p></li></ul><h3 id=metric-client-tool>Metric Client Tool <a href=#metric-client-tool class=anchor>üîó</a></h3><ul><li><a href=https://www.npmjs.com/package/prom-client target=_blank rel=noopener>prom-client</a></li><li><a href=https://opentracing.io/ target=_blank rel=noopener>OpenTracing(CNCFÈ†ÖÁõÆ)</a></li><li><a href=https://opencensus.io/ target=_blank rel=noopener>OpenCensus(GoogleÈñãÊ∫êÈ†ÖÁõÆ)</a></li><li><a href=https://opentelemetry.io/ target=_blank rel=noopener>Opentelemetry</a> OpenTracing and OpenCensus are merged</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>otel</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;@opentelemetry/api&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>MeterProvider</span>, <span style=color:#a6e22e>PeriodicExportingMetricReader</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;@opentelemetry/sdk-metrics&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Resource</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;@opentelemetry/resources&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>SemanticResourceAttributes</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;@opentelemetry/semantic-conventions&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>as</span> <span style=color:#a6e22e>GoogleMonitoring</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;@google-cloud/opentelemetry-cloud-monitoring-exporter&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>resource</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Resource</span>.<span style=color:#66d9ef>default</span>().<span style=color:#a6e22e>merge</span>(
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Resource</span>({
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>SemanticResourceAttributes</span>.<span style=color:#a6e22e>SERVICE_NAME</span>]<span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;cp-node-graphql-endpoint&#39;</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>SemanticResourceAttributes</span>.<span style=color:#a6e22e>SERVICE_VERSION</span>]<span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;0.1.0&#39;</span>,
</span></span><span style=display:flex><span>  }),
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>metricReader</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>PeriodicExportingMetricReader</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>exporter</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>GoogleMonitoring</span>.<span style=color:#a6e22e>MetricExporter</span>(),
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Default is 60000ms (60 seconds). Set to 3 seconds for demonstrative purposes only.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>exportIntervalMillis</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>30000</span>,
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>myServiceMeterProvider</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>MeterProvider</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>resource</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>resource</span>,
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>myServiceMeterProvider</span>.<span style=color:#a6e22e>addMetricReader</span>(<span style=color:#a6e22e>metricReader</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Set this MeterProvider to be global to the app being instrumented.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>otel</span>.<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>setGlobalMeterProvider</span>(<span style=color:#a6e22e>myServiceMeterProvider</span>);
</span></span></code></pre></div><h2 id=choosing-logs-or-metrics>Choosing logs or metrics? <a href=#choosing-logs-or-metrics class=anchor>üîó</a></h2><h2 id=client-moinitor>Client moinitor <a href=#client-moinitor class=anchor>üîó</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>Action</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Request</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Request&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Response</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Response&#39;</span>,
</span></span><span style=display:flex><span>  Error <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Error&#39;</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>meterProvider</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>otel</span>.<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>getMeterProvider</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>meter</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>meterProvider</span>.<span style=color:#a6e22e>getMeter</span>(<span style=color:#e6db74>&#39;client-monitor-metric&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>reqCounter</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>meter</span>.<span style=color:#a6e22e>createCounter</span>(<span style=color:#e6db74>&#39;Node.client.request.counter&#39;</span>, {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>description</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Client request counter&#39;</span>,
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>resCounter</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>meter</span>.<span style=color:#a6e22e>createCounter</span>(<span style=color:#e6db74>&#39;Node.client.response.counter&#39;</span>, {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>description</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Client response counter&#39;</span>,
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>errorCounter</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>meter</span>.<span style=color:#a6e22e>createCounter</span>(<span style=color:#e6db74>&#39;Node.client.error.counter&#39;</span>, {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>description</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Client response counter&#39;</span>,
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>clientMonitor</span><span style=color:#f92672>&lt;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// eslint-disable-next-line @typescript-eslint/ban-types
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>T</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>object</span> <span style=color:#f92672>&amp;</span> { <span style=color:#a6e22e>vendor</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>string</span>; <span style=color:#a6e22e>blockchain</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>string</span>; [<span style=color:#a6e22e>K</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>string</span>]<span style=color:#f92672>:</span> <span style=color:#a6e22e>any</span> }
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;</span>(<span style=color:#a6e22e>client</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>T</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>T</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Proxy(<span style=color:#a6e22e>client</span>, {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>get</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>obj</span>, <span style=color:#a6e22e>prop</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>startTime</span> <span style=color:#f92672>=</span> Date.<span style=color:#a6e22e>now</span>();
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>clientName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>obj</span>.<span style=color:#a6e22e>constructor</span>.<span style=color:#a6e22e>name</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>vendor</span>, <span style=color:#a6e22e>blockchain</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>client</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>funcName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>prop</span>.<span style=color:#a6e22e>toString</span>();
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>identifier</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;CLIENT_MONITOR&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>logAndCount</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>action</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Action</span>, <span style=color:#a6e22e>error</span><span style=color:#f92672>?:</span> <span style=color:#a6e22e>any</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>commonLogData</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>identifier</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>action</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>funcName</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>client</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>clientName</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>vendor</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>blockchain</span>,
</span></span><span style=display:flex><span>          ...(<span style=color:#a6e22e>action</span> <span style=color:#f92672>!==</span> <span style=color:#a6e22e>Action</span>.<span style=color:#a6e22e>Request</span> <span style=color:#f92672>?</span> { <span style=color:#a6e22e>latency</span><span style=color:#f92672>:</span> (Date.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>-</span> <span style=color:#a6e22e>startTime</span>) <span style=color:#f92672>/</span> <span style=color:#ae81ff>1000</span> } <span style=color:#f92672>:</span> {}),
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>traceLogger</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>child</span>({
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>namespace</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;client&#39;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#39;logging.googleapis.com/trace&#39;</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>uuidv4</span>(),
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>counterData</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>clientName</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>funcName</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>vendor</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>blockchain</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>instanceId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>INSTANCE_CUSTOM_ID</span>,
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>traceLogger</span>.<span style=color:#a6e22e>info</span>({ ...<span style=color:#a6e22e>commonLogData</span>, <span style=color:#a6e22e>error</span> });
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>errorCounter</span>.<span style=color:#a6e22e>add</span>(<span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>counterData</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>traceLogger</span>.<span style=color:#a6e22e>info</span>({ ...<span style=color:#a6e22e>commonLogData</span> });
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>action</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>Action</span>.<span style=color:#a6e22e>Response</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>resCounter</span>.<span style=color:#a6e22e>add</span>(<span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>counterData</span>);
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>action</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>Action</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>reqCounter</span>.<span style=color:#a6e22e>add</span>(<span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>counterData</span>);
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>run</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> (...<span style=color:#a6e22e>args</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>any</span>[]) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>logAndCount</span>(<span style=color:#a6e22e>Action</span>.<span style=color:#a6e22e>Request</span>);
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>obj</span>[<span style=color:#a6e22e>prop</span> <span style=color:#a6e22e>as</span> <span style=color:#a6e22e>string</span>](...<span style=color:#a6e22e>args</span>);
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>logAndCount</span>(<span style=color:#a6e22e>Action</span>.<span style=color:#a6e22e>Response</span>);
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>result</span>;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>logAndCount</span>(<span style=color:#a6e22e>Action</span>.Error, <span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>throw</span> <span style=color:#a6e22e>err</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>typeof</span> <span style=color:#a6e22e>obj</span>[<span style=color:#a6e22e>prop</span> <span style=color:#a6e22e>as</span> <span style=color:#a6e22e>string</span>] <span style=color:#f92672>!==</span> <span style=color:#e6db74>&#39;function&#39;</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>obj</span>[<span style=color:#a6e22e>prop</span> <span style=color:#a6e22e>as</span> <span style=color:#a6e22e>string</span>] <span style=color:#f92672>:</span> <span style=color:#a6e22e>run</span>;
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div><div class=tags><a href=https://and2352000.github.io/tags/cloud>cloud</a>
<a href=https://and2352000.github.io/tags/javascript>javascript</a>
<a href=https://and2352000.github.io/tags/sre>sre</a></div></section></main><footer id=footer><div class=copyright>¬© Copyright
2024
<span class=split><svg fill="#bbb" width="15" height="15" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15"><path d="M13.91 6.75c-1.17 2.25-4.3 5.31-6.07 6.94-.1903.1718-.4797.1718-.67.0C5.39 12.06 2.26 9 1.09 6.75-1.48 1.8 5-1.5 7.5 3.45 10-1.5 16.48 1.8 13.91 6.75z"/></svg></span></div><div class=powerby>Powered by <a href=http://www.gohugo.io/>Hugo</a> Theme By <a href=https://github.com/nodejh/hugo-theme-mini>nodejh</a></div></footer></body></html>